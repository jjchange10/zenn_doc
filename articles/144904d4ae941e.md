---
title: "Alloyã‚’ä½¿ã£ãŸã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ“ˆ"
type: "tech"
topics: ["alloy", "opentelemetry", "loki", "tempo", "observability"]
published: true
---


# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ï¼SREã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®Koseã§ã™ï¼
Grafanaã«æœ€è¿‘ãƒãƒã£ã¦ã„ã‚‹ç§ã§ã™ãŒã€Grafana [Alloy](https://grafana.com/docs/alloy/latest/)ã£ã¦ã”å­˜çŸ¥ã§ã™ã‹ï¼Ÿ
ç§ã¯æœ€è¿‘çŸ¥ã£ãŸã®ã§ã™ãŒã€Promtailã®å¾Œç¶™ã¨ãªã‚‹è£½å“ã®ã‚ˆã†ã§ã™ã€‚
ãã“ã§ã€ä»Šå›ã¯Alloyã‚’ä½¿ã£ãŸã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®åŸºç¤ã‚’ã¾ã¨ã‚ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
ï¼ˆã¡ã‚‡ã£ã¨é•·ããªã‚Šãã†ã ã£ãŸã®ã§ã€ãƒ­ã‚°ã¨ãƒˆãƒ¬ãƒ¼ã‚¹æƒ…å ±ã«é–¢ã—ã¦ã“ã®è¨˜äº‹ã§ã¯èª¬æ˜ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ï¼‰

## å‰æçŸ¥è­˜ã¨ç’°å¢ƒ

- åŸºæœ¬çš„ãªLinuxã‚³ãƒãƒ³ãƒ‰ã®çŸ¥è­˜
- Kubernetesã®åŸºæœ¬çš„ãªæ“ä½œ
- ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®åŸºæœ¬çš„ãªæ¦‚å¿µ
- Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆã“ã®è¨˜äº‹ã§ã¯EKSã§æ§‹ç¯‰ã—ã¦ã¾ã™ã€‚ï¼‰
- Prometheus, GrafanaãŒç’°å¢ƒã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## åˆ©ç”¨ã™ã‚‹æŠ€è¡“

| æŠ€è¡“ | èª¬æ˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|------|------|------------|
| Grafana Loki | ãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | 3.4.2 |
| Grafana tempo | åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | 2.7.1|
| Grafana Alloy | ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | v4.0.1 |
| Grafana | å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ« | 11.6.1 |
| Prometheus | ãƒ¡ãƒˆãƒªãƒƒã‚¯åé›† | v3.3.1 |
| EKS | ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | v1.31 |
| Helm | Kubernetesãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | v3.17.3 |


# æœ¬æ–‡
## Grafana Alloyã«ã¤ã„ã¦
Grafana Alloyã¯ã€Grafanaç¤¾ãŒé–‹ç™ºã—ãŸOSSã®ãƒ‡ãƒ¼ã‚¿åé›†ãƒ„ãƒ¼ãƒ«ã§ã€ã•ã¾ã–ã¾ãªã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ­ã‚°ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’åŠ¹ç‡çš„ã«é›†ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚OpenTelemetryæŠ€è¡“ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦ã„ã‚‹ãŸã‚ã€ç‰¹å®šã®ãƒ™ãƒ³ãƒ€ãƒ¼ã«ä¾å­˜ã›ãšã€å¤šæ§˜ãªã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºã§ãã‚‹æŸ”è»Ÿæ€§ãŒç‰¹å¾´ã§ã™ã€‚

## Alloyã®ä¸»ãªæ©Ÿèƒ½
Alloyã«ã¯ä»¥ä¸‹ã®3ã¤ã®ä¸»è¦æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™:

### Collect
[æ§˜ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://grafana.com/docs/alloy/latest/reference/components/)ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€Opentelemetryã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã‹ã‚‰ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¾ã™ã€‚
ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã¯ Alloyã«Pushã™ã‚‹ã“ã¨ã‚‚ã€AlloyãŒãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰Pullã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€æ§˜ã€…ãªãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ã¾ãŸã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã«é–¢ã—ã¦ã¯ã€è¨ˆè£…ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒˆãƒ¬ãƒ¼ã‚¹åé›†æ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ï¼‰ãŒå¿…è¦ã§ã™ã®ã§ã€Opentelemetry SDKãªã©ã§è¨ˆè£…ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

### Transform
ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã€ãƒ©ãƒ™ãƒ«ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ãŸã‚Šã€ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã—ãŸã‚Šã§ãã¾ã™ã€‚

### Write
OpenTelemetry äº’æ›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼ã€Grafana ã‚¹ã‚¿ãƒƒã‚¯ã€ã¾ãŸã¯ Grafana Cloud ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™ã€‚

## Grafana Tempoã«ã¤ã„ã¦
Grafana Tempoã¯ã€Grafana LabsãŒé–‹ç™ºã—ãŸé«˜ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã™ã€‚Tempoã¯ã€Grafana Alloyã‚„Opentelemetry Collectorãªã©ã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®é«˜ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆS3ã€GCSã€Azure Blobãªã©ï¼‰ã«ä¿å­˜ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹IDã«ã‚ˆã‚Šæ¤œç´¢ã™ã‚‹ã“ã¨ã«ç‰¹åŒ–ã—ã¦ã„ã¾ã™ã€‚
ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯Lokiã¨ä¼¼ãŸã¨ã“ã‚ãŒã‚ã‚Šã€æ¯”è¼ƒçš„ã«ã‚ã‹ã‚Šã‚„ã™ã„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨ãªã£ã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚
èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯[å…¬å¼Document](https://grafana.com/docs/tempo/latest/)ã‚’ã”ç¢ºèªãã ã•ã„


## ä»Šå›ã®æ¤œè¨¼
ã•ãã€ã“ã“ã‹ã‚‰ã¯æ‰‹ã‚’å‹•ã‹ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼ä»Šå›ã®æ¤œè¨¼ã§ã¯ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã¨ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã™ã‚‹ã¨ã“ã‚ã‚’å®Ÿæ–½ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®å›³ã¯ä»Šå›æ§‹ç¯‰ã™ã‚‹ç’°å¢ƒã®å…¨ä½“åƒã§ã™ã€‚

![æ§‹æˆå›³](/images/verification_architecture.png)
*æ¤œè¨¼ç’°å¢ƒæ§‹æˆå›³*

| ä¸»è¦æ©Ÿèƒ½ | ä»Šå›ã®æ¤œè¨¼ã§è©¦ã™ã“ã¨ |
|--------------|------|
| Collect | Kubernetes Podã‹ã‚‰ãƒ­ã‚°ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— |
| Transform | Kubernetesç”¨ã®ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ |
| Write | Loki, Tempoã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ |

:::message
ã“ã“ã§èª¤è§£ã—ã¦ã»ã—ããªã„ã§ã™ãŒã€Alloyã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯åé›†ãŒã§ããªã„ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»Šå›ã¯ã€ãƒ¡ãƒˆãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’Prometheusã§åé›†ã—ã¦ãŠã‚Šã¾ã™ãŒAlloyã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã®åé›†ã‚‚å¯èƒ½ã¨ãªã£ã¦ãŠã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦[Mimir](https://grafana.com/docs/mimir/latest/)ãªã©ã«ãƒ‡ãƒ¼ã‚¿è»¢é€ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿æ ¼ç´å¯èƒ½ã§ã™ã€‚
ãŸã ã—ã€ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã®ã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€šçŸ¥ã§ãã‚‹ä»•çµ„ã¿ã¯ãªã•ãã†ãªã®ã§ã€åˆ¥ã§å®Ÿè£…ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚
ã¨ãªã‚‹ã®ã§ã€ã¾ã ã¾ã ã€PrometheusãŒé¸æŠã•ã‚Œã‚‹ã®ã‹ãªã£ã¦å€‹äººçš„ã«ã¯æ€ã£ã¦ã¾ã™ãƒ»ãƒ»(Grafana Alertã‚‚ã‚ã‚‹ã®ã§ãã‚Œã§ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†ãªã©ã¯ã§ããã†ã§ã™ãŒ)
:::

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
### Alloyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
ã“ã“ã§ã¯ã€Alloyã®åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã™ã‚‹ã¨Alloyã¯Kubernetesã®DaemonSetã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚
ãã‚Œã§ã¯ã€Grafana Alloyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
#### 1. ãƒªãƒã‚¸ãƒˆãƒªè¿½åŠ 
```bash
helm repo add grafana https://grafana.github.io/helm-charts
```

#### 2. Values.yamlã®å–å¾—
```bash
helm show values grafana/alloy > values.yaml
```

#### 3. Values.yamlã‚’å¤‰æ›´
Alloyã®è¨­å®šã«ã¯é–¢ã—ã¦ã¯å¾Œã»ã©èª¬æ˜ã—ã¾ã™ã®ã§ã“ã¡ã‚‰ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚values.yamlã‚’è¨­å®šã—ãªãã¦ã‚‚ã€èµ·å‹•è‡ªä½“ã¯ã§ãã¾ã™ã€‚

#### 4. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
helm upgrade --install alloy grafana/alloy --create-namespace --namespace alloy -f values.yaml
```

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ç¢ºèª
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€Alloyã®PodãŒæ­£å¸¸ã«èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```bash
kubectl get pods -n alloy
```

æ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
NAMESPACE          NAME                                                 READY   STATUS    RESTARTS   AGE
alloy              alloy-2xx77                                          2/2     Running   0          3h13m
alloy              alloy-b6qhq                                          2/2     Running   0          3h13m
alloy              alloy-r2tbp                                          2/2     Running   0          3h13m
alloy              alloy-z4rq5                                          2/2     Running   0          3h13m
```

### Tempoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
Grafana Tempoã«ã¯2ç¨®é¡ã®Helmã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯tempo-distributedã‚’ä½¿ç”¨ã—ã¦ã¾ã™ã€‚
**tempo-distributed Helm chart** :   microservices modeã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã«åˆ©ç”¨
**tempo Helm chart** : monolithic (single binary) modeã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã«åˆ©ç”¨

ç¶šã„ã¦ã€Tempoã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã¿ã¾ã™ã€‚
#### 1. ãƒªãƒã‚¸ãƒˆãƒªç™»éŒ²
```bash
helm repo add grafana https://grafana.github.io/helm-charts
```

#### 2. valuesã®å–å¾—
```bash
helm show values grafana/tempo-distributed > values.yaml
```

#### 3. Values.yamlã‚’å¤‰æ›´
values.yamlã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ã§, S3ã«Traceãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã§ãã‚‹ã‚ˆã†ãªtempoã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
å½“ç„¶ã€S3ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€äº‹å‰ã«S3ãƒã‚±ãƒƒãƒˆã‚’ç”¨æ„ã—ã¦ãŠãã€irsaãªã©ã«ã‚ˆã‚ŠAWSã®ãƒ­ãƒ¼ãƒ«ã‚’Kubernetesã®ServiceAccountã«ç´ã¥ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ï¼ˆLokiã®æ™‚ã¨åŒã˜è¨­å®šãªã®ã§AWSå´ã®è¨­å®šã«é–¢ã—ã¦ã¯[ã“ã¡ã‚‰](https://zenn.dev/nono0601/articles/27f41edf465d26?redirected=1#%E3%83%AD%E3%82%B0%E4%BF%9D%E7%AE%A1%E5%A0%B4%E6%89%80%E3%81%AE%E5%A4%89%E6%9B%B4)ã‚’å‚ç…§ãã ã•ã„ï¼‰
```yaml
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::<AccoutID>:role/tempo-irsa-role
ingester:
  persistence:
    enabled: true
    storageClass: gp2
    size: 10Gi
metricsGenerator:
  enabled: true

## ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘ä»˜ã‘ã‚‹çª“å£
distributor:
  config:
    log_received_spans:
      enabled: true
    log_discarded_spans:
      enabled: true

## otlpã‚’å—ã‘ä»˜ã‘ã‚‹ã“ã¨ã«ã‚ˆã‚Š,ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ4318/TCP,4317/TCPãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™
traces:
  otlp:
    http:
      enabled: true
    grpc:
      enabled: true


storage:
  trace:
    backend: s3
    s3:
      bucket: test-tempo-traces-bucket
      endpoint: s3.ap-northeast-1.amazonaws.com
      region: ap-northeast-1
```

#### 4. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
helm upgrade --install tempo grafana/tempo-distributed --create-namespace -n tempo -f values.yaml
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€tempoã®PodãŒæ­£å¸¸ã«èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ï¼š
```bash
kubectl get pods -n tempo
```

æ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¦ã„ã‚‹å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
```
NAMESPACE          NAME                                                 READY   STATUS    RESTARTS   AGE
tempo              tempo-compactor-6567d999-5gk5b                       1/1     Running   0          22h
tempo              tempo-distributor-75cc847cfd-mhnb2                   1/1     Running   0          22h
tempo              tempo-ingester-0                                     1/1     Running   0          21h
tempo              tempo-ingester-1                                     1/1     Running   0          21h
tempo              tempo-ingester-2                                     1/1     Running   0          22h
tempo              tempo-memcached-0                                    1/1     Running   0          22h
tempo              tempo-metrics-generator-6d94b7fdf6-fmc8x             1/1     Running   0          22h
tempo              tempo-querier-64b754d5d7-l44wt                       1/1     Running   0          22h
tempo              tempo-query-frontend-784d9986f9-lmbbl                1/1     Running   0          22h
```

### Lokiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
Lokiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã«ã¤ã„ã¦ã¯ã€ä»¥å‰ã®è¨˜äº‹ã§èª¬æ˜ã—ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„
https://zenn.dev/kose/articles/27f41edf465d26


## Alloyã®è¨­å®š
Alloyã¯ã€æ§˜ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã£ã¦ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€K8sãƒ­ã‚°ã®å–å¾—ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã®ä¾‹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
ä»–ã«ã‚‚å¤šããƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã®ã§ã€[Reference](https://grafana.com/docs/alloy/latest/reference/)æ¢ã—ã¦ã¿ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

:::message
helmã§è¨­å®šã™ã‚‹å ´åˆã¯alloy.configMap.contentã«è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
:::

### K8sãƒ­ã‚°ã®å–å¾—
Kubernetesã®ãƒ­ã‚°åé›†è¨­å®šã§ã™ã€‚
```hcl
# Kubernetesã‹ã‚‰å…¨ã¦ã®Podæƒ…å ±ã‚’æ¤œå‡º
discovery.kubernetes "pod" {
            role = "pod"
}

# æ¤œå‡ºã—ãŸPodæƒ…å ±ã«ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã™ã‚‹è¨­å®š
discovery.relabel "pod_logs" {
    targets = discovery.kubernetes.pod.targets
    
    # Kubernetesåå‰ç©ºé–“ã‚’namespaceãƒ©ãƒ™ãƒ«ã¨ã—ã¦è¿½åŠ 
    rule {
        source_labels = ["__meta_kubernetes_namespace"]
        action = "replace"
        target_label = "namespace"
    }   
    # Podåã‚’podãƒ©ãƒ™ãƒ«ã¨ã—ã¦è¿½åŠ 
    rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        action = "replace"
        target_label = "pod"
    }
    # ã‚³ãƒ³ãƒ†ãƒŠåã‚’containerãƒ©ãƒ™ãƒ«ã¨ã—ã¦è¿½åŠ 
    rule {
        source_labels = ["__meta_kubernetes_pod_container_name"]
        action = "replace"
        target_label = "container"
    }
}

# Kubernetesã®ãƒ­ã‚°ã‚’å–å¾—ã—ã¦Lokiã«é€ä¿¡ã™ã‚‹ãŸã‚ã®è¨­å®š
loki.source.kubernetes "pod" {
    targets = discovery.relabel.pod_logs.output
    forward_to = [loki.process.pod_logs.receiver]
}

# loki.processã¯ä»–ã®Lokiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’å—ã‘å–ã‚Šã€1ã¤ä»¥ä¸Šã®å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’é©ç”¨ã—ã¾ã™
loki.process "pod_logs" {
    stage.static_labels {
        values = {
            cluster = "kose-eks-welcomestudy",
        }
    }
    forward_to = [loki.write.loki.receiver]
}
      
# Lokiã¸ã®é€ä¿¡è¨­å®š
loki.write "loki" {
    endpoint {
        url = "http://loki-distributor.loki.svc.cluster.local:3100/loki/api/v1/push"
    }
}
```

### ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
OpenTelemetryãªã©ã§è¨ˆè£…ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã€‚
```hcl
## OTLPãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã®è¨­å®š
## ã“ã®ãƒ¬ã‚·ãƒ¼ãƒãƒ¼ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã™
otelcol.receiver.otlp "default" {
    grpc {} ## gRPCãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã®å—ä¿¡ã‚’æœ‰åŠ¹åŒ–
    http {} ## HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã®å—ä¿¡ã‚‚æœ‰åŠ¹åŒ–
    output {
        traces = [otelcol.processor.k8sattributes.default.input] ## å—ä¿¡ã—ãŸãƒˆãƒ¬ãƒ¼ã‚¹ã‚’K8så±æ€§ãƒ—ãƒ­ã‚»ãƒƒã‚µã«è»¢é€
    }
}

## Kuberneteså±æ€§ãƒ—ãƒ­ã‚»ãƒƒã‚µã®è¨­å®š
## ã“ã®ãƒ—ãƒ­ã‚»ãƒƒã‚µã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã«Kubernetesé–¢é€£ã®å±æ€§ã‚’è¿½åŠ ã—ã¾ã™
otelcol.processor.k8sattributes "default" {
    extract {
        metadata = [
            "k8s.namespace.name",  ## Kubernetesåå‰ç©ºé–“
            "k8s.pod.name",        ## Podå
            "k8s.container.name",  ## ã‚³ãƒ³ãƒ†ãƒŠå
        ]
    }
    output {
        traces = [otelcol.exporter.otlp.default.input] ## å±æ€§ãŒè¿½åŠ ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ã‚¹ã‚’OTLPã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã«è»¢é€
    }
}

## OTLPã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã®è¨­å®š
## ã“ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã¯ã€å‡¦ç†ã•ã‚ŒãŸãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’Tempoã«è»¢é€ã—ã¾ã™
otelcol.exporter.otlp "default" {
    client {
        endpoint = "tempo-distributor.tempo.svc.cluster.local:4317" ## Tempoã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        tls {
            insecure = true ## æœ¬ç•ªç’°å¢ƒã§ã¯TLSã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™
        }
    }
}
```
### æ­£å¸¸æ€§ã®ç¢ºèª
Grafanaãªã©ã®å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«ã§ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¾ã™ï¼š
![alloy-trace](/images/alloy_trace.png)

## ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®å®Ÿè£…
ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®å®Ÿè£…ã¯ãƒ¡ãƒˆãƒªãƒƒã‚¯ã€ãƒ­ã‚°ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’åé›†ã™ã‚‹ã“ã¨ã ã‘ã§ã¯çµ‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹ã‚’ç†è§£ã™ã‚‹ä¸Šã§ã¯ã€ã“ã®ï¼“ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚’çµ„ã¿åˆã‚ã›ã¦æ‰±ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯ã€ãƒ­ã‚°ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ã‚ˆã‚Šã‚·ã‚¹ãƒ†ãƒ å†…éƒ¨ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## Trace To Logs
Trace To Logsã¯ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ãƒ­ã‚°ã¸ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’èª¿æŸ»ã—ã¦ã„ã‚‹ã¨ãã«é–¢é€£ã™ã‚‹ãƒ­ã‚°ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªã§ãã¾ã™ã€‚

### è¨­å®šæ–¹æ³•
Grafanaã§ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆTempoï¼‰ã®è¨­å®šã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tempo-datasource
  namespace: grafana
  labels:
    grafana_datasource: "true"
data:
  tempo-datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Tempo
        type: tempo
        url: http://tempo-query-frontend.tempo.svc.cluster.local:3100/
        access: proxy
        editable: true
        jsonData:
          lokiSearch:
            datasourceUid: Loki
  # ã„ããªã‚ŠV2ã§ã™ãŒã€ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã—ã¦ã¾ã™ã€‚ã€€https://grafana.com/docs/grafana/latest/datasources/tempo/configure-tempo-data-source/#example-file
          tracesToLogsV2:
            datasourceUid: Loki  # Lokiãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æŒ‡å®šï¼ˆGrafanaã®Lokiãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹UIDï¼‰
            tags:
              - key: "k8s.container.name"  # Tempo trace field
                value: "container"         # Loki field
            spanStartTimeShift: "-1m"
            spanEndTimeShift: "1m"
            filterByTraceID: true
            filterBySpanID: false
  # æ·±ãèª¬æ˜ã¯ã—ã¾ã›ã‚“ãŒtraceã¨Metricsã‚’ç´ã¥ã‘ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™
          tracesToMetrics:
            datasourceUid: 'Prometheus'
            tags: 
              - key: "k8s.container.name"
                value: "container"
            spanStartTimeShift: "-10m"
            spanEndTimeShift: "10m"
            queries:
              - name: 'Memory Usage'
                query: avg(container_memory_usage_bytes{__ignore_usage__="",$$__tags} )       
```

:::message
tracesToLogsV2ã«ã¤ã„ã¦ã¯tracesToLogsã§ã‚‚å®Ÿè£…å¯èƒ½ã§ã—ãŸã€‚ãã®å ´åˆä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ãŒDocumentã«è¼‰ã£ã¦ã„ãªã„ã¨ã„ã†ã®ã¨ã€å¯èª­æ€§ã®å•é¡Œã‹ã‚‰ç§ã¯tracesToLogsV2ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
```yaml
  tracesToLogs:
    datasourceUid: Loki
    tags: ["container"]
    mappedTags:
      - key: "k8s.container.name"
        value: "container"
    mapTagNamesEnabled: true

```

:::

### çµæœ
ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ã§ãƒ­ã‚°ã¸ã®ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š
![trace_to_log](/images/trace_to_logs.png)

## log to Traces
Log to Tracesã¯ã€ãƒ­ã‚°ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹ã¸ã®ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ã‚°ã‚’èª¿æŸ»ã—ã¦ã„ã‚‹ã¨ãã«é–¢é€£ã™ã‚‹ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ç¢ºèªã§ãã¾ã™ã€‚

### è¨­å®šæ–¹æ³•
Grafanaã§ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼ˆLokiï¼‰ã®è¨­å®šã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-datasource
  namespace: grafana
  labels:
    grafana_datasource: "true"
data:
  loki-datasource.yaml: |
    apiVersion: 1
    datasources:
      - name: Loki
        type: loki
        url: http://loki-query-frontend.loki.svc.cluster.local:3100/
        access: proxy
        editable: false
        jsonData:
          # Log to Tracesã®è¨­å®š
          derivedFields:
            - datasourceUid: 'Tempo'                  # Tempoãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è­˜åˆ¥å­
              matcherRegex: 'trace_id=([a-f0-9]{32})' # ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ãƒˆãƒ¬ãƒ¼ã‚¹IDã‚’æŠ½å‡ºã™ã‚‹æ­£è¦è¡¨ç¾
              name: 'TraceID'                         # UIã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒªãƒ³ã‚¯å
              url: '$${__value.raw}'                  # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯
```

ä»Šå›ãƒ­ã‚°ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«TraceidãŒå‡ºã‚‹ã‚ˆã†ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§ã€matcherRegexãªã©ã‚’ãã‚Œã«åˆã†ã‚ˆã†ãªå€¤ã§è¨­å®šã—ã¦ã¾ã™ã€‚
```log
2025/05/21 02:48:07 Request received: path=/hello, method=GET, trace_id=4228e430a1f94dc866fb862c68189da7
```

### çµæœ

ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã§ãƒˆãƒ¬ãƒ¼ã‚¹IDãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒªãƒ³ã‚¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

![log_to_trace](/images/log_to_traces.png)

# ã¾ã¨ã‚
ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€Alloyã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨æ–¹æ³•ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚
Alloyã«ã¯ã€ã“ã‚Œä»¥å¤–ã«ã‚‚æ§˜ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚ã‚Šã€å¤šãã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå¯èƒ½ã§ã™ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã€Grafana Labsã®è£½å“ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã€åˆ©ç”¨é¸æŠè‚¢ã¨ã—ã¦å…¥ã£ã¦ãã‚‹ã¨æ€ã„ã¾ã™ãŒã€ç‹¬è‡ªã®æ›¸ãæ–¹ãŒå¤šã„ã®ã§ã¡ã‚‡ã£ã¨ã ã‘æˆ¸æƒ‘ã†ã“ã¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ã“ã®ã‚ˆã†ãªã“ã¨ã«æŒ‘æˆ¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼ˆä»Šå¾Œè¨˜äº‹ã«ã—ã¦ã„ãã¾ã™ï¼‰
- æ§˜ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è©¦ã—ã¦ã¿ã‚‹
- OpenTelemetry Collectorã¨ã®é•ã„ã®èª¿æŸ»

ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€œğŸ‰

# å‚è€ƒè³‡æ–™
- [OpenTelemetry Go](https://opentelemetry.io/docs/instrumentation/go/)
- [Alloy Documentation](https://docs.grafana.com/alloy/latest/)
- [Grafana Labs](https://grafana.com/)
- [OpenTelemetryã¨Grafanaã§Logsã¨Metricsã¨Tracesã‚’æ¥ç¶šã™ã‚‹](https://qiita.com/hir00/items/1339f81ffba155195e17)


# å‚™è€ƒï¼šã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨ˆè£…ã™ã‚‹ã«ã¯æ§˜ã€…ãªæ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ã‚ˆã‚Šå®Ÿè·µçš„ãªã‚‚ã®ã¨ã—ã¦ã€OpenTelemetryã‚’åˆ©ç”¨ã—ã¾ã™ã€‚Alloyè‡ªä½“ãŒOpenTelemetryã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ãŸã‚ã€ç›¸æ€§ãŒè‰¯ãã€ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªé€£æºãŒå¯èƒ½ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯Goã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¾‹ã«ã—ã¦ã„ã¾ã™ãŒã€Javaã‚„Pythonãªã©ä»–ã®è¨€èªã§ã‚‚åŒæ§˜ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¯èƒ½ã§ã™ã€‚

## ç’°å¢ƒæº–å‚™

ã¾ãšã€æ–°ã—ã„Goãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
mkdir my-go-app
cd my-go-app
go mod init my-go-app
```

## å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

OpenTelemetryã¨ãã®é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š

```bash
go get go.opentelemetry.io/otel
go get go.opentelemetry.io/otel/sdk/trace
go get go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc
go get go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp
```

ä»¥ä¸‹ã¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ç°¡å˜ãªHTTPã‚µãƒ¼ãƒãƒ¼ã®ä¾‹ã§ã™ã€‚å„éƒ¨åˆ†ã®å½¹å‰²ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ï¼š

```go
package main

import (
	"context"
	"fmt"
	"log"
	"net/http"

	"go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp"
	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/attribute"
	"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
	"go.opentelemetry.io/otel/sdk/resource"
	sdktrace "go.opentelemetry.io/otel/sdk/trace"
	semconv "go.opentelemetry.io/otel/semconv/v1.17.0"
)

// ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã®åˆæœŸåŒ–
// ã“ã®é–¢æ•°ã¯ã€OpenTelemetryãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’è¨­å®šã—ã€Alloyã«ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¾ã™
func initTracer(ctx context.Context) func() {
	// OTLP gRPCã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ã®ä½œæˆ
	// Alloyã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’æŒ‡å®šã—ã¾ã™ã€‚å®Ÿéš›ã®ç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„
	exporter, err := otlptracegrpc.New(ctx,
		otlptracegrpc.WithEndpoint("alloy.alloy.svc.cluster.local:4317"), // Alloyã‚„Collectorã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
		otlptracegrpc.WithInsecure(), // æœ¬ç•ªç’°å¢ƒã§ã¯TLSã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™
	)
	if err != nil {
		log.Printf("failed to create exporter: %v", err)
	}

	// ã‚µãƒ¼ãƒ“ã‚¹åãªã©ã®ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è¨­å®š
	// ã“ã‚Œã«ã‚ˆã‚Šã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ç™ºç”Ÿã—ãŸã‹ãŒè­˜åˆ¥ã§ãã¾ã™
	res, err := resource.New(ctx,
		resource.WithAttributes(
			semconv.ServiceName("hello-api"), // ã‚µãƒ¼ãƒ“ã‚¹åã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„
		),
	)
	if err != nil {
		log.Printf("failed to create resource: %v", err)
	}

	// ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä½œæˆã¨è¨­å®š
	tp := sdktrace.NewTracerProvider(
		sdktrace.WithBatcher(exporter), // ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒå‡¦ç†
		sdktrace.WithResource(res),     // ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã®è¿½åŠ 
	)
	otel.SetTracerProvider(tp)

	// ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³é–¢æ•°ã‚’è¿”ã™ï¼ˆãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ï¼‰
	return func() {
		if err := tp.Shutdown(ctx); err != nil {
			log.Printf("failed to shutdown TracerProvider: %v", err)
		}
	}
}

// Hello APIã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
// ã“ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™
func helloHandler(w http.ResponseWriter, req *http.Request) {
	// æ‰‹å‹•ã§spanã‚’ä½œæˆï¼ˆç‰¹å®šã®å‡¦ç†ã‚’è©³ç´°ã«è¨ˆæ¸¬ã™ã‚‹ãŸã‚ï¼‰
	_, span := otel.Tracer("hello-handler").Start(req.Context(), "handle-hello")
	defer span.End() // å¿…ãšspanã‚’çµ‚äº†ã•ã›ã‚‹ã“ã¨ãŒé‡è¦ã§ã™

	// ãƒˆãƒ¬ãƒ¼ã‚¹IDã‚’å–å¾—ï¼ˆãƒ­ã‚°ã¨ãƒˆãƒ¬ãƒ¼ã‚¹ã®é–¢é€£ä»˜ã‘ã«ä½¿ç”¨ï¼‰
	traceID := span.SpanContext().TraceID().String()

	// ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã¨ãƒˆãƒ¬ãƒ¼ã‚¹IDã‚’ãƒ­ã‚°å‡ºåŠ›
	// ã“ã®ãƒ­ã‚°ã¯ã‚ã¨ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã¨é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¾ã™
	log.Printf("Request received: path=%s, method=%s, trace_id=%s", req.URL.Path, req.Method, traceID)

	// ã‚¹ãƒ‘ãƒ³ã«å±æ€§ã‚’è¿½åŠ ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚„è©³ç´°ãªåˆ†æã«å½¹ç«‹ã¤ï¼‰
	span.SetAttributes(attribute.String("custom.attribute", "hello-world"))

	// å®Ÿéš›ã®å‡¦ç†
	fmt.Fprintln(w, "Hello, World")

	// ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡ã‚’ãƒ­ã‚°
	log.Printf("Response sent: trace_id=%s", traceID)
}

func main() {
	ctx := context.Background()
	shutdown := initTracer(ctx)
	defer shutdown() // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«ãƒˆãƒ¬ãƒ¼ã‚µãƒ¼ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

	// æ¨™æº–ã®HTTPãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«OpenTelemetry Middlewareã‚’è¿½åŠ 
	// ã“ã‚Œã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè‡ªå‹•çš„ã«ãƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¾ã™
	handler := otelhttp.NewHandler(http.HandlerFunc(helloHandler), "hello-endpoint")

	http.Handle("/hello", handler)

	fmt.Println("Starting server at :8080")
	if err := http.ListenAndServe(":8080", nil); err != nil {
		log.Printf("server error: %v", err)
	}
}
```

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¾ã™ï¼š

```bash
go run ./
```

## å‹•ä½œç¢ºèª

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ï¼š

```bash
curl http://localhost:8080/hello # localhostã¯å„ç’°å¢ƒã§èª­ã¿æ›¿ãˆã¦ãã ã•ã„

# æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚Œã° "Hello, World" ã¨è¡¨ç¤ºã•ã‚Œã¾ã™
```


