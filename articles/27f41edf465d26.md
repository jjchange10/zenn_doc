---
title: "ã€Grafana Lokiã€‘Kubernetesç’°å¢ƒã§ã®ãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã¨é‹ç”¨ã®åŸºæœ¬"
emoji: "ğŸ“Š"
type: "tech"
topics: ["loki", "kubernetes", "observability", "monitoring"]
published: true
---

# ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã‚ï¼SREã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®Koseã§ã™ï¼
Grafanaã£ã¦ã„ã„ã§ã™ã‚ˆã­ã€œã€‚
æœ€è¿‘ã€ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã®æŠ€è¡“ã«ã©ãƒãƒã‚Šä¸­ã§ã€ãƒ­ã‚°ç®¡ç†ãƒ„ãƒ¼ãƒ«ã®Grafana Lokiã‚’èª¿ã¹ã¦ã„ã¾ã—ãŸã€‚
ãã“ã§ã€å°å…¥æ™‚ã«è©°ã¾ã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§ã€è‡ªåˆ†ã®ç†è§£ã®ãŸã‚ã«ã‚‚åˆ©ç”¨æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‰æçŸ¥è­˜ã¨ç’°å¢ƒ

- åŸºæœ¬çš„ãªLinuxã‚³ãƒãƒ³ãƒ‰ã®çŸ¥è­˜
- Kubernetesã®åŸºæœ¬çš„ãªæ“ä½œ
- ãƒ­ã‚°ç®¡ç†ã®åŸºæœ¬çš„ãªæ¦‚å¿µ
- Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãŒæ§‹ç¯‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆã“ã®è¨˜äº‹ã§ã¯EKSã§æ§‹ç¯‰ã—ã¦ã¾ã™ã€‚ï¼‰
- Prometheus, GrafanaãŒç’°å¢ƒã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨

## åˆ©ç”¨ã™ã‚‹æŠ€è¡“

| æŠ€è¡“ | èª¬æ˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
|------|------|------------|
| Grafana Loki | ãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | 3.4.2|
| Grafana | å¯è¦–åŒ–ãƒ„ãƒ¼ãƒ« | 11.6.1 |
| Prometheus | ãƒ¡ãƒˆãƒªãƒƒã‚¯åé›† | v3.3.1 |
| Fluent Bit | ãƒ­ã‚°åé›†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ | v4.0.1 |
| EKS | ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | v1.31 |
| Helm | Kubernetesãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ | v3.17.3 |


# æœ¬æ–‡

## Grafana Lokiã«ã¤ã„ã¦

Lokiã¯ã€Grafana LabsãŒé–‹ç™ºã—ãŸPrometheusã«ã‚¤ãƒ³ã‚¹ãƒ‘ã‚¤ã‚¢ã•ã‚ŒãŸæ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å¯ç”¨æ€§ã®é«˜ã„ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã®ãƒ­ã‚°é›†ç´„ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚Prometheusã¨ã¯ç•°ãªã‚Šã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ã¯ãªããƒ­ã‚°ã«ç„¦ç‚¹ã‚’å½“ã¦ã€Pullã§ã¯ãªãPushã§ãƒ­ã‚°ã‚’åé›†ã—ã¾ã™ã€‚

ã¾ãŸã€Lokiã¯ãƒ­ã‚°ã®ãƒ©ãƒ™ãƒ«ã«é–¢ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆPrometheusã®ãƒ©ãƒ™ãƒ«ã®ã‚ˆã†ãªã‚‚ã®ï¼‰ã®ã¿ã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã™ã‚‹ã¨ã„ã†è€ƒãˆã«åŸºã¥ã„ã¦æ§‹ç¯‰ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã¯åœ§ç¸®ã•ã‚Œã€Amazon Simple Storage Service (S3)ã‚„Google Cloud Storage (GCS)ãªã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã‚„ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸Šã«ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

Lokiã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€ç°¡å˜ãªæ§‹æˆå›³ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ãŸã€‚
ï¼ˆğŸŸ¦ï¼šWriteã€ğŸŸ¥ï¼šReadã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨æ€ã£ã¦ã„ãŸã ã‘ã‚Œã°ãƒ»ã€‚ãƒ»ï¼‰

![Lokiã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆå›³](/images/Loki_architecture.png)


ä»¥ä¸‹ã«ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç°¡å˜ã«ã¾ã¨ã‚ã¾ã™ã€‚
ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²ï¼š
1. **Distributor**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ï¼ˆPushãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã‚’æœ€åˆã«å—ã‘å–ã‚‹å½¹å‰²ã‚’æŒã¤ã€Lokiã®æ›¸ãè¾¼ã¿ãƒ‘ã‚¹ã®å…¥ã‚Šå£ã§ã™
2. **Ingester**: å—ã‘å–ã£ãŸãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«ãƒ¡ãƒ¢ãƒªã«ä¿æŒã—ã€æœ€çµ‚çš„ã«é•·æœŸä¿å­˜å…ˆï¼ˆS3ã€GCSã€Azure Blobãªã©ï¼‰ã«æ›¸ãè¾¼ã‚€å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚ã¾ãŸã€èª­ã¿å–ã‚Šæ™‚ã«ã¯ã€æœ€è¿‘å–ã‚Šè¾¼ã‚“ã ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®ãƒ‡ãƒ¼ã‚¿ã‚‚è¿”ã—ã¾ã™ã€‚
3. **Querier**: LogQLã‚¯ã‚¨ãƒªã®å®Ÿè¡Œå½¹ã§ã™ã€‚å®Ÿéš›ã«ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ãƒ»å–å¾—ã—ã€çµæœã‚’è¿”ã™ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚
4. **Query Frontend**: èª­ã¿å–ã‚Šå‡¦ç†ã®ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚¿ã§ã™ã€‚Querierã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒã¡ã€èª­ã¿å–ã‚Šãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æœ€é©åŒ–ã‚„è² è·åˆ†æ•£ã‚’è¡Œã„ã¾ã™ã€‚
5. **Ruler**: Lokiã«ãŠã‘ã‚‹ãƒ«ãƒ¼ãƒ«è©•ä¾¡ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†ã‚’è¡Œã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚Prometheusã¨åŒæ§˜ã«ã€ãƒ«ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚’ç›£è¦–ã—ã€ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç™ºç«ã•ã›ã¾ã™

ãã®ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://grafana.com/docs/loki/latest/get-started/components/)ã«è©³ã—ãè¼‰ã£ã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰

Lokiã¯ä»¥ä¸‹ã®3ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

1. **Monolithic mode**
   - å˜ä¸€ã®ãƒã‚¤ãƒŠãƒªã¨ã—ã¦ï¼‘ã¤ã®ãƒ—ãƒ­ã‚»ã‚¹å†…ã§å‹•ä½œ
   - å°è¦æ¨¡ç’°å¢ƒå‘ã‘
   - é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒã«é©ã—ã¦ã„ã‚‹

2. **Simple Scalable**
   - ä¸­è¦æ¨¡ç’°å¢ƒå‘ã‘
   - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’Read, Write, Backendã«åˆ†é›¢

3. **Distributed Mode**
   - æœ¬ç•ªç’°å¢ƒå‘ã‘
   - å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç‹¬ç«‹ã—ã¦å‹•ä½œ
   - ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã¨å¯ç”¨æ€§ãŒé«˜ã„

ç´°ã‹ã„æ§‹æˆã«ã¤ã„ã¦ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è©³ã—ã„èª¬æ˜ãŒè¼‰ã£ã¦ã„ã‚‹ã®ã§[ãã¡ã‚‰](https://grafana.com/docs/loki/latest/get-started/deployment-modes/)ã‚’ã”è¦§ãã ã•ã„

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
ã“ã“ã‹ã‚‰ã¯ã€Lokiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åŸºæœ¬çš„ãªåˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¾ã™ï¼
ä»¥ä¸‹ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã¯,Distributed Modeã‚’ç°¡æ˜“çš„ã«å®Ÿè£…ã™ã‚‹æ‰‹é †ã§èª¬æ˜ã—ã¾ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¤ã„ã¦ã¯ã€EKSä¸Šã«Helmã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

### Helmãƒªãƒã‚¸ãƒˆãƒªã®è¿½åŠ 
```bash
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
```

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™
ä»¥ä¸‹ã®å†…å®¹ã§`values.yaml`ã‚’ä½œæˆã—ã¾ã™ï¼š
ãƒ­ã‚°ä¿ç®¡ã«é–¢ã—ã¦ã¯ã¾ãšã€æ‰‹å§‹ã‚ã«S3ã¨äº’æ›æ€§ã®ã‚ã‚‹Minioã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
ã‚‚ã¡ã‚ã‚“S3ãªã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«å¤‰æ›´ã‚‚å¯èƒ½ã§ã€S3ã¸ã®å¤‰æ›´æ–¹æ³•ã¯å¾Œè¿°ã—ã¾ã™ã€‚

```yaml
deploymentMode: Distributed
loki:
  auth_enabled: false
  commonConfig:
  ã€€## ingesterã®ãƒ¬ãƒ—ãƒªã‚«æ•°ãŒ1ãªã®ã§ã€replication_factorã¯1ã¨ã—ã¾ã™
    replication_factor: 1
  ## s3ã¨ãªã£ã¦ã¾ã™ãŒminioã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã§ã€å†…éƒ¨ã§minioã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
  storage:
    type: s3

# Configuration for the gateway
gateway:
  enabled: false

# Configuration for the write pod(s)
write:
  replicas: 0
  
read:
  replicas: 0
  
backend:
  replicas: 0

# å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è¨­å®š,æ¤œè¨¼ã®ãŸã‚replicasã¯1ã¨ã—ã¦ã„ã¾ã™ã€‚
ingester:
  replicas: 1
  zoneAwareReplication:
    enabled: false

distributor:
  replicas: 1

querier:
  replicas: 1

queryFrontend:
  replicas: 1

queryScheduler:
  replicas: 1

indexGateway:
  replicas: 1

compactor:
  replicas: 1

ruler:
  enabled: true
  replicas: 1

# MinIOè¨­å®š
minio:
  enabled: true
  replicas: 1
  persistence:
    size: 5Gi
    storageClass: gp2
```

### Lokiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¤‰æ›´ã—ãŸvalues.yamlã‚’æŒ‡å®šã—ã¦ã€helmã‚³ãƒãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
```bash
# Lokiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
helm upgrade --install loki grafana/loki \
  --create-namespace --namespace loki \
  -f values.yaml
```

ä»¥ä¸‹ã®ã‚ˆã†ã«å…¨ã¦Runningã«ãªã‚Œã°èµ·å‹•å®Œäº†ã§ã™ã€‚
```bash
loki               loki-canary-b456t                                    1/1     Running     0          71m
loki               loki-canary-lc54g                                    1/1     Running     0          71m
loki               loki-canary-wxgdw                                    1/1     Running     0          71m
loki               loki-canary-xd7l7                                    1/1     Running     0          71m
loki               loki-chunks-cache-0                                  2/2     Running     0          71m
loki               loki-compactor-0                                     1/1     Running     0          36m
loki               loki-distributor-6567649c7f-kxj9d                    1/1     Running     0          36m
loki               loki-index-gateway-0                                 1/1     Running     0          33m
loki               loki-ingester-0                                      1/1     Running     0          36m
loki               loki-querier-645976dc89-2z4xc                        1/1     Running     0          36m
loki               loki-query-frontend-b75f8c997-44lqr                  1/1     Running     0          36m
loki               loki-query-scheduler-747778767f-l4qws                1/1     Running     0          36m
loki               loki-results-cache-0                                 2/2     Running     0          71m
loki               loki-ruler-0                                         1/1     Running     0          33m
```

### ãƒ­ã‚°åé›†
ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ãŸã‚ã«ã€Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã«Fluent Bitã‚’Deamonsetã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€Kubernetesã®ãƒ­ã‚°ã‚’Lokiã«é€ã‚‹è¨­å®šã‚’ã—ã¾ã™ã€‚
å°å…¥ã«ã¤ã„ã¦ã¯è©³ã—ãã¯èª¬æ˜ã—ã¾ã›ã‚“ãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‚è€ƒã«ãªã‚Šãã†ãªã®ã§[ã“ã¡ã‚‰](https://grafana.com/docs/loki/latest/send-data/fluentbit/)ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„

ä»¥ä¸‹ã®è¨­å®šã§lokiã®distributorã«ãƒ­ã‚°ã‚’é€ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```yaml
[OUTPUT]
    Name loki
    Match kube.*
    Host loki-distributor.loki.svc.cluster.local
    Port 3100
```

ã“ã“ã¾ã§ã§ã€Grafanaã‹ã‚‰LogãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚ãŠæ‰‹å…ƒã®Grafanaã§ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚
Grafanaã§ãƒ­ã‚°ãŒç¢ºèªã§ãã‚Œã°åŸºç¤ã¯å®Œäº†ã¨ãªã‚Šã¾ã™ã€‚ç¶šã„ã¦ã€å°‘ã—å®Ÿè·µçš„ãªã“ã¨ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ï¼
![Logçµæœ](/images/log_result.png)

## ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
Lokiã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€šçŸ¥ã™ã‚‹ãŸã‚ã«alert-managerã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
ç§ã®ç’°å¢ƒã§ã¯prometheusã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸéš›ã«ã€alert-managerã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ãŸã‚ãã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

Lokiã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¨­å®šã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§è¨­å®šã—ã¾ã™

1. **ãƒ«ãƒ¼ãƒ«ã®å®šç¾©**: LogQLã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™
2. **ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®è¨­å®š**: é€šçŸ¥å…ˆã®è¨­å®š
3. **ãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤**: Kubernetesç’°å¢ƒã§ã®ãƒ«ãƒ¼ãƒ«é©ç”¨æ–¹æ³•

### ãƒ«ãƒ¼ãƒ«ã®å®šç¾©
Lokiã®ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹ã«ã¯ã€[LogQL (Loki Query Language) ](https://grafana.com/docs/loki/latest/query/log_queries/)ã¨å‘¼ã°ã‚Œã‚‹ã‚¯ã‚¨ãƒªè¨€èªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚LogQLã¯PromQLã«ä¼¼ãŸæ§‹æ–‡ã‚’æŒã¡ã€ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®é¸æŠã¨ã€é¸æŠã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒ å†…ã®ãƒ­ã‚°è¡Œã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ­ã‚°ã‚’æ¤œç´¢ã—ã¾ã™ã€‚

LogQLã®ã‚¯ã‚¨ãƒªã¯ã€åŸºæœ¬çš„ã«ä»¥ä¸‹ã®2ã¤ã®éƒ¨åˆ†ã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ã€‚

+ **ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼**: 
æ¤œç´¢å¯¾è±¡ã®ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒ©ãƒ™ãƒ«ã‚’ä½¿ã£ã¦æŒ‡å®šã—ã¾ã™ã€‚ 
{label1="value1", label2="value2"} ã®ã‚ˆã†ã«ä¸­æ‹¬å¼§ {} ã§å›²ã‚“ã§æŒ‡å®šã—ã¾ã™ã€‚
+ **ãƒ©ã‚¤ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼**: 
é¸æŠã—ãŸãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ å†…ã®å„ãƒ­ã‚°è¡Œã®å†…å®¹ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
ãƒ‘ã‚¤ãƒ— | ã®å¾Œã«æ¼”ç®—å­ã¨æ¡ä»¶ã‚’æŒ‡å®šã—ã¾ã™

ã“ã‚Œã‚‰ã‚’åˆ©ç”¨ã—ã¦ã€è©²å½“ã®ãƒ­ã‚°ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ï¼šnamespace=lokiã‹ã¤level=errorã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€è¡Œã®ã¿ã‚’è¡¨ç¤º
```yaml
{namespace="argocd"} |= `level=error`
```

ã¾ãŸã€ä¸Šè¨˜ã®log queriesã‚’æ‹¡å¼µã—ã¦[Metric queries](https://grafana.com/docs/loki/latest/query/metric_queries/)ã¨ã—ã¦ä½œæˆã™ã‚‹ã“ã¨ã§
ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦å®šç¾©ã§ãã¾ã™ã€‚
ä¾‹ï¼šéå»5åˆ†é–“ã«10ä»¶ä»¥ä¸Šç™ºç”Ÿã—ãŸå ´åˆ
```yaml
count_over_time({namespace="argocd"} |= `level=error` [5m]) > 9
```

ã“ã‚Œã§ä¸‹è¨˜ã®ã‚ˆã†ãªã‚¢ãƒ©ãƒ¼ãƒˆãŒå®Œæˆã—ã¾ã™ã€‚
**ã€Œargocd ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‹ã‚‰å‡ºåŠ›ã•ã‚ŒãŸãƒ­ã‚°ã®ä¸­ã§ã€ãƒ­ã‚°è¡Œã« level=error ã¨ã„ã†æ–‡å­—åˆ—ã‚’å«ã‚€ã‚‚ã®ãŒã€éå»5åˆ†é–“ã«10ä»¶ä»¥ä¸Šç™ºç”Ÿã™ã‚‹å ´åˆã€**


æ¬¡ã«ã€å®Œäº†ã—ãŸã‚¢ãƒ©ãƒ¼ãƒˆå®šç¾©ã‚’Lokiã«çµ„ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ruleãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã¯localã«ä¿ç®¡ã—ã¦ãŠã‚Šã¾ã™ã€‚â€»å†…éƒ¨çš„ã«ã¯ConfigMapã§ä¿ç®¡

Lokiã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«ã¯ã€Prometheusã®ãƒ«ãƒ¼ãƒ«å½¢å¼ã¨ä¼¼ã¦ã„ã¾ã™ã€‚åŸºæœ¬çš„ãªæ§‹é€ ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
localã«ä¿ç®¡ã™ã‚‹ãŸã‚,ruler.directoriesã®ä¸‹ã«è¨˜è¼‰ã—ã¦ã¾ã™ã€‚
```yaml
ruler:
  enabled: true
  replicas: 1
  directories:
    tenant_foo:
      ## Lokiã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«ã‚’Textãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦è¨­å®šã—ã¦ãã ã•ã„
      rules1.txt: |
        groups:
          - name: should_fire
            rules:
              - alert: HighPercentageError
                expr: |
                  count_over_time({namespace="argocd"} |= `level=error` [5m]) > 9
                for: 1m
                labels:
                  severity: warning
                annotations:
                  summary: High error rate
```

### ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã®è¨­å®š

alertmanager_urlã«alertmanagerã®URLã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml
loki:
  rulerConfig:
    ## Alertmanagerã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„
    alertmanager_url: http://prometheus-alertmanager.prometheus.svc.cluster.local:9093

    ## localã«ä¿ç®¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªè¨­å®šã¨ãªã‚Šã¾ã™
    storage:
      type: local
      local:
        directory: /etc/loki/rules
    rule_path: /tmp/loki
```

## ãƒ­ã‚°ä¿ç®¡å ´æ‰€ã®å¤‰æ›´
ä»Šã¾ã§ã€MinIOã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ãŒã€æœ¬ç•ªç’°å¢ƒã‚’æƒ³å®šã—ã¦AWS S3ã¸ã®ç§»è¡Œã‚’å®Ÿæ–½ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

1. S3ãƒã‚±ãƒƒãƒˆã®ä½œæˆ
S3ãƒã‚±ãƒƒãƒˆã®ä½œæˆã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆã—ã¾ã™ã€‚
```hcl
## Lokiã«ã‚ˆã‚‹ãƒ­ã‚°ä¿ç®¡ã®ãŸã‚ã®ãƒã‚±ãƒƒãƒˆ
module "s3_bucket" {
    source = "terraform-aws-modules/s3-bucket/aws"
    version = "4.6.0"

    bucket = "test-loki-logs-bucket"
    object_ownership = "BucketOwnerPreferred"

    versioning = {
        enabled = true
    }
}
```

2. IAMãƒ­ãƒ¼ãƒ«ã®è¨­å®š
ç¶šã„ã¦ã€S3ã«LokiãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã¨ã‚ˆã†ã«IRSAã®è¨­å®šã‚’ã—ã¾ã™ã€‚
```hcl
resource "aws_iam_role" "loki_role" {
  name = "loki-irsa-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = "sts:AssumeRoleWithWebIdentity"
        Principal = {
          Federated = module.eks.oidc_provider_arn ##eks moduleã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã“ã®ã‚ˆã†ã«è¨˜è¼‰ã—ã¦ã¾ã™ãŒã€eksnodeã®Oidcã‚’è¨­å®šã—ã¦ãã ã•ã„
        }
        Condition = {
          StringEquals = {
            "${replace(module.eks.cluster_oidc_issuer_url, "https://", "")}:sub": "system:serviceaccount:loki:loki" ##Lokiã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
            "${replace(module.eks.cluster_oidc_issuer_url, "https://", "")}:aud": "sts.amazonaws.com"
          }
        }
      }
    ]
  })
}

resource "aws_iam_role_policy" "loki_policy" {
  name = "loki-policy"
  role = aws_iam_role.loki_role.id

  policy = jsonencode({
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "s3:GetObject",
          "s3:PutObject",
          "s3:DeleteObject",
          "s3:ListBucket",
          "s3:GetBucketLocation",
          "s3:DeleteObject"
        ],
        "Resource": [
          "*"
        ]
      }
    ]
  })
}
```
3. Lokiã®è¨­å®šå¤‰æ›´
values.yamlã®loki.storageã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã«å¤‰æ›´ã—ã€schemaConfigã«ã¦S3ã‚’è¨­å®šã—ã¾ã™ã€‚
```yaml
loki:
  storage:
    bucketNames:
      chunks: test-loki-logs-bucket
      ruler: test-loki-logs-bucket
      admin: test-loki-logs-bucket
    type: s3
    s3:
      region: ap-northeast-1
    
  schemaConfig:
    configs:
      - from: 2020-04-01
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
```

serviceaccountã‚’è¨­å®šã—ã¾ã™ã€‚
```yaml
serviceAccount:
  create: true
  annotations: 
    eks.amazonaws.com/role-arn: arn:aws:iam::<AccountID>:role/loki-irsa-role ##(æ³¨: <AccountID> ã¯ã”è‡ªèº«ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã«ç½®ãæ›ãˆã¦ãã ã•ã„)
```

minioã‚’falseã«ã—ã¾ã™ã€‚minioã‚’falseã«ã—ãªã„ã¨ã€S3ã«ã†ã¾ããƒ­ã‚°ã‚’é€ã£ã¦ãã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
```
minio:
  enabled: false
```

ã“ã‚Œã§ã€helmã‚’upgradeã™ã‚Œã°S3ã®ãƒã‚±ãƒƒãƒˆå†…ã«fakeï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒŠãƒ³ãƒˆIDï¼‰ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã€ãƒ­ã‚°ãŒãƒãƒ£ãƒ³ã‚¯ã¨ã—ã¦åœ§ç¸®ã•ã‚ŒãŸçŠ¶æ…‹ã§ä¿ç®¡ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚


# ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯ã€Grafana Lokiã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰ã¨é‹ç”¨ã«ã¤ã„ã¦åŸºç¤çš„ãªèª¬æ˜ã‚’ã—ã¾ã—ãŸã€‚
Alertãªã©ã®ç®¡ç†ã‚„ã€ãƒ­ã‚°ã®ä¿ç®¡å ´æ‰€ãªã©å†…éƒ¨ã‚’ã‚ˆãç†è§£ã—ãªã„ã¨å‹•ããŒã‚ã‹ã‚‰ãªã„ã¨ã“ã‚ãŒã‚ã‚Šè‹¦åŠ´ã—ã¾ã—ãŸã€‚

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ã€AlertRuleã®S3ä¿ç®¡ã‚„ã€ãƒ­ã‚°ã®å‰Šé™¤ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ï¼ˆãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³è¨­å®šï¼‰ãªã©ã‚’ã‚„ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ï¼
ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€œğŸ‰

## å‚è€ƒè³‡æ–™

- [Grafana Lokiå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://grafana.com/docs/loki/latest/)
- [Fluent Bitå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.fluentbit.io/)
- [Helm Charts for Grafana Loki](https://github.com/grafana/helm-charts)

